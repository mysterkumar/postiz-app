# ============================================================================
# Multi-stage build for Postiz with custom backend PDF upload feature
# Base: node:22-alpine with production optimizations
# ============================================================================

FROM node:22-alpine AS base

# Install system dependencies
RUN apk add --no-cache \
    g++ \
    make \
    py3-pip \
    bash \
    nginx

# Create nginx user safely (skip if already exists)
RUN addgroup -S www 2>/dev/null || true && \
    adduser -S www -G www 2>/dev/null || true && \
    mkdir -p /var/log/nginx /var/cache/nginx /uploads && \
    chown -R www:www /var/log/nginx /var/cache/nginx /uploads && \
    chmod -R 755 /uploads


# ============================================================================
# Builder stage
# ============================================================================

FROM base AS builder

# Install pnpm globally
RUN npm install -g pnpm@10.6.1

WORKDIR /app

# Copy lockfile and package for layer caching
COPY pnpm-lock.yaml package.json ./

# Set memory optimization for build processes (increased for large monorepo)
ENV NODE_OPTIONS="--max-old-space-size=6144"

# Copy the full source code before installing
COPY . .

# Install dependencies after copying schema files
RUN --mount=type=cache,target=/root/.cache/pnpm \
    pnpm install --no-frozen-lockfile

# Build backend first to ensure dist/main.js exists for PM2 runtime
RUN --mount=type=cache,target=/app/.cache/pnpm \
    pnpm run build:backend

# Build all other apps with parallel processing
RUN --mount=type=cache,target=/app/.cache/pnpm \
    pnpm run build

# Build backend to ensure dist/main.js exists for PM2 runtime
RUN pnpm run build:backend

# Copy nginx configuration
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

# ============================================================================
# Production stage (lightweight final image)
# ============================================================================

FROM node:22-alpine AS production

# Install runtime dependencies only
RUN apk add --no-cache \
    g++ \
    make \
    bash \
    nginx

# Create nginx user safely (skip if already exists)
RUN addgroup -S www 2>/dev/null || true && \
    adduser -S www -G www 2>/dev/null || true && \
    mkdir -p /var/log/nginx /var/cache/nginx /uploads && \
    chown -R www:www /var/log/nginx /var/cache/nginx /uploads && \
    chmod -R 755 /uploads

# Install global tools
RUN npm install -g pnpm@10.6.1 pm2

# Set working directory
WORKDIR /app

# Copy nginx configuration from builder
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

# Copy built apps and dependencies from builder
COPY --from=builder /app/apps ./apps
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/libraries ./libraries

# Copy any other necessary files (backend, frontend, workers, cron scripts)
COPY --from=builder /app/apps ./apps
COPY --from=builder /app/libraries ./libraries

# Set permissions for www user
RUN chown -R www:www /app /uploads && \
    chmod -R 755 /app

# ============================================================================
# Environment Variables Configuration
# ============================================================================

# Postiz Core Configuration
ENV NODE_ENV=production \
    PORT=3000 \
    FRONTEND_PORT=4200

# Cloudflare R2 PDF Upload Configuration (Custom Backend Feature)
ENV CLOUDFLARE_ACCOUNT_ID="" \
    CLOUDFLARE_ACCESS_KEY="" \
    CLOUDFLARE_SECRET_ACCESS_KEY="" \
    CLOUDFLARE_BUCKETNAME="" \
    CLOUDFLARE_REGION="" \
    CLOUDFLARE_BUCKET_URL=""

# Optional: Additional PDF upload configuration
ENV PDF_UPLOAD_ENABLED=true \
    PDF_UPLOAD_MAX_SIZE=52428800

# Expose ports
# 5000: Nginx proxy
# 3000: Backend API
# 4200: Frontend
EXPOSE 5000 3000 4200

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:5000/api/health || exit 1

# ============================================================================
# Start Process
# ============================================================================

# Switch to www user for security
USER www

# Start nginx and Postiz services via pm2
CMD ["sh", "-c", "nginx && pnpm run pm2"]
